@page "/Auth/Login"
@model CEG_RazorWebApp.Pages.Auth.LoginModel
@{
	ViewData["Title"] = "Login Page";
	Layout = "~/Pages/Shared/_Layout.cshtml";
}
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="author" content="Untree.co">
	<link rel="shortcut icon" href="#">
	<meta name="description" content="">
	<meta name="keywords" content="bootstrap, bootstrap4">
	<link rel="stylesheet" href="~/css/main.css">
	<title>@ViewData["Title"]</title>
</head>
<body class="background">
	<div style="background-image: url(~/images/Background.png); background-repeat:no-repeat; background-size: 100% 100%;">
		<div class="main-container">
			<div class="row justify-content-between">
				<div class="col-lg-6">
					<div class="box-container">
						<div class="d-flex justify-content-center box-header light-green">
							<h5><b>User login</b></h5>
						</div>
						<div id="alertContainer"></div>
						<div class="d-flex box-body justify-content-center">
							<form class="reg-form" method="post" id="loginForm">
								@{
									if (ViewBag.error != null)
									{
										<span class="text-danger">@ViewBag.error</span>
									}
								}
								<div class="form-group">
									<input placeholder="Username" asp-for="AuthenRequest.Username" class="form-control" />
									<span asp-validation-for="AuthenRequest.Username" class="text-danger"></span>
								</div>
								<div class="form-group">
									<input type="password" placeholder="Password" asp-for="AuthenRequest.Password" class="form-control" />
									<span asp-validation-for="AuthenRequest.Password" class="text-danger"></span>
								</div>
								<a href="#" class="float-end">Forgot Password?</a>
								<button class="reg-button btn1 light-green" type="submit" value="Login">Login</button>
								<div>
									<p class="text-center my-3">Or</p>
									<button class="login-gg">
										<a href="@Url.Action("GoogleLogin", "Auth")">
											<img src="~/images/Google__G__Logo.svg" alt="logo-G"> Login with Google
										</a>
									</button>
								</div>
								<div>
								</div>
								<div class="reg-text">
									New to this ? Join us <a href="@Url.Action("Register","Auth")" class="link-success">Sign up</a>
								</div>
							</form>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="write-container" style="text-align:center">
						<div class="write-title">Children English Game</div>
					</div>
					<div class="write-text">
					</div>
					<div class="row">
						<div class="d-flex justify-content-center">
							@* <img class="bird-image" src="~/images/bulbul.png"> *@
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		var apiUrl = sessionStorage.getItem('apiUrl');
        var questionList = [];
        $(document).ready(function () {
			$('#loginForm').submit(function (event) {
                event.preventDefault(); // Prevent the form from submitting normally

                //Get the form data
                var formData = {
					username: $('input[id="AuthenRequest_Username"]').val(),
					password: $('input[id="AuthenRequest_Password"]').val(),
                };

                //Make the AJAX request
				callApiPostLogin(formData);
            });
        });
        // Function to display alerts
        function showAlert(type, message) {
            var alertHtml = '';

            if (type === 'success') {
                alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" id="notif">
                        <i class='bx bx-message-alt-x p-1'></i>
                        <strong class="mr-1">` + message + `</strong>
                        <button type="button" class="close h-100" data-dismiss="alert" aria-label="Close">
                            <span><i class='bx bx-x'></i></span>
                        </button>
                    </div>
                `;
            } else if (type === 'error') {
                alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" id="notif">
                        <i class='bx bx-message-alt-x p-1'></i>
                        <strong class="mr-1">` + message + `</strong>
                        <button type="button" class="close h-100" data-dismiss="alert" aria-label="Close">
                            <span><i class='bx bx-x'></i></span>
                        </button>
                    </div>
                `;
            }

            // Inject the alert HTML into the alert container
            $('#alertContainer').html(alertHtml);
        }
		function callApiPostLogin(formData) {
			$.ajax({
				url: apiUrl + 'Account/Login', // Specify your Razor Page here
				type: 'POST',
				data: JSON.stringify(formData),
				contentType: 'application/json; charset=utf-8',
				success: function (response) {
					// Handle success (display a success message or redirect, etc.)
					if (response.status) {
						showAlert('success', "Login successfully");
						sessionStorage.setItem('token', response.data.accessToken);
						sessionStorage.setItem('role', response.data.roleName);
						sessionStorage.setItem('usrId', response.data.accountId);
						sessionStorage.setItem('usrName', response.data.userName);
						// Use switch to redirect based on role name
						switch (response.data.roleName) {
							case 'Admin':
								// Redirect to admin dashboard
								window.location.href = '/Admin/Index';
								break;

							case 'Teacher':
								// Redirect to teacher dashboard
								window.location.href = '/Teacher/Index';
								break;

							case 'Parent':
								// Redirect to parent dashboard
								window.location.href = '/Parent/Index';
								break;

							case 'Student':
								// Redirect to student dashboard
								window.location.href = '/Student/Index';
								break;

							default:
								// Redirect to a generic page or error page if role is not recognized
								window.location.href = '/Auth/Login';
								break;
						}
						$('#loginForm').trigger("reset");
						console.log(window.location.href);
					} else {
						console.error("API returned false status.");
					}
				},
				error: function (xhr, status, error) {
					// Handle error (display the validation message, etc.)
					alert("Error in api call:" + error);
					console.error("Error in api call:", error);
				}
			});
		}
	</script>
</body>
</html>